<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OptimizaciÃ³n del Caso</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700;800&family=Source+Sans+3:wght@400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css">
  <script>
    // Guardar fuentes Mermaid ANTES de que Mermaid procese los elementos.
    // window._mermaidSrc se llena en DOMContentLoaded, antes de mermaid.run().
    window._mermaidSrc = {};
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    // Tema inicial: aplicar ANTES del primer render para evitar flash
    (function() {
      try {
        var saved = localStorage.getItem('villarrica-theme') || 'light';
        if (saved === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        mermaid.initialize({ startOnLoad: false, theme: saved === 'dark' ? 'dark' : 'neutral' });
      } catch(e) {
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
      }
    })();
  </script>
</head>
<body>
  <!-- Hamburger mobile (fixed, solo visible en â‰¤768px) -->
  <button class="menu-toggle no-print" onclick="document.body.classList.toggle('sidebar-open')" aria-label="Abrir menÃº">
    <span></span><span></span><span></span>
  </button>
  <div class="sidebar-overlay no-print" onclick="document.body.classList.remove('sidebar-open')"></div>

  <!-- Sidebar (sin botÃ³n de colapso interno) -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <a href="index.html" class="sidebar-home-link">Panel del caso</a>
    </div>
    <ul>
<li><a href="CASE.html">Caso Airbnb Villarrica</a></li>
<li><a href="optimization-tracker.html">OptimizaciÃ³n del Caso</a></li>
<li class="section-title">InvestigaciÃ³n</li>
<ul>
<li><a href="01_investigacion/INVESTIGACION-COMPILADA.html">InvestigaciÃ³n Compilada</a></li>
<li><a href="01_investigacion/investigacion-marco-legal-airbnb.html">Investigacion</a></li>
<li><a href="01_investigacion/investigacion-normativa-sii.html">Investigacion Normativa SII</a></li>
<li><a href="01_investigacion/investigacion-spa-operadora.html">Investigacion</a></li>
<li><a href="01_investigacion/jurisprudencia-airbnb-arriendo-amoblado.html">Investigacion de Jurisprudencia y Casos Reales</a></li>
</ul>
<li class="section-title">Analisis</li>
<ul>
<li><a href="02_analisis/ANALISIS-TRIBUTARIO.html">Analisis Tributario</a></li>
<li><a href="02_analisis/clasificacion-pro-pyme-art20.html">ClasificaciÃ³n Pro-PyME</a></li>
<li><a href="02_analisis/mapeo-costos-operacionales.html">Mapeo De Costos Operacionales</a></li>
</ul>
<li class="section-title">Simulacion</li>
<ul>
<li><a href="03_simulacion/SIMULACION-5-ANOS.html">Simulacion A 5 Anos</a></li>
</ul>
<li class="section-title">Estructura</li>
<ul>
<li><a href="04_estructura/COMPARATIVA-ALTERNATIVAS.html">Comparativa De Alternativas</a></li>
<li><a href="04_estructura/PROPUESTA-ESTRUCTURA.html">Propuesta De Estructura Tributaria</a></li>
</ul>
<li class="section-title">RevisiÃ³n</li>
<ul>
<li><a href="05_revision/2026-02-15-correcciones-roast.html">Correcciones Post-Roast</a></li>
<li><a href="05_revision/2026-02-15-proof.html">Verificacion De Compliance</a></li>
<li><a href="05_revision/2026-02-15-roast.html">Revision Adversarial Sii</a></li>
</ul>
<li class="section-title">Entregable</li>
<ul>
<li><a href="99_entregable/ACCIONES-LEGACY.html">Acciones Humanas</a></li>
<li><a href="99_entregable/PANEL.html">Panel de Control</a></li>
<li class="section-title">CrÃ­tico</li>
<ul>
<li><a href="99_entregable/01_critico/C1-validar-art20-n3.html">C1</a></li>
<li><a href="99_entregable/01_critico/C2-inicio-actividades-claudia.html">C2</a></li>
<li><a href="99_entregable/01_critico/C3-deducibilidad-intereses.html">C3</a></li>
<li><a href="99_entregable/01_critico/C4-comparables-arriendo.html">C4</a></li>
</ul>
<li class="section-title">Bloqueantes</li>
<ul>
<li><a href="99_entregable/02_bloqueantes/B1-reglamento-copropiedad.html">B1</a></li>
</ul>
<li class="section-title">Siguientes Pasos</li>
<ul>
<li><a href="99_entregable/03_siguientes-pasos/P1-seguro-rc.html">P1</a></li>
<li><a href="99_entregable/03_siguientes-pasos/P2-iva-comision-airbnb.html">P2</a></li>
<li><a href="99_entregable/03_siguientes-pasos/P3-revision-estatutos.html">P3</a></li>
<li><a href="99_entregable/03_siguientes-pasos/P4-registro-sernatur.html">P4</a></li>
</ul>
<li class="section-title">Con Supervision Ia</li>
<ul>
<li><a href="99_entregable/06_con-supervision-ia/R1-reunion-contador-consolidada.html">R1. ReuniÃ³n Consolidada con Contador</a></li>
</ul>
<li class="section-title">Operacion</li>
<ul>
<li><a href="99_entregable/07_operacion/CALENDARIO.html">Guia De Operacion</a></li>
<li><a href="99_entregable/07_operacion/contactos-y-links.html">Contactos Y Links</a></li>
<li class="section-title">Anual</li>
<ul>
<li><a href="99_entregable/07_operacion/anual/guia-anual.html">Guia Anual</a></li>
</ul>
<li class="section-title">Eventual</li>
<ul>
<li><a href="99_entregable/07_operacion/eventual/guia-por-reserva.html">Guia Por Reserva</a></li>
</ul>
<li class="section-title">Mensual</li>
<ul>
<li><a href="99_entregable/07_operacion/mensual/guia-mensual.html">Guia Mensual</a></li>
</ul>
</ul>
<li class="section-title">Entrega Profesional</li>
<ul>
<li><a href="99_entregable/entrega-profesional/checklist-verificacion.html">Checklist De Verificacion Profesional</a></li>
<li><a href="99_entregable/entrega-profesional/ENTREGA-PROFESIONAL.html">Entrega Para Revision Profesional</a></li>
</ul>
</ul>
</ul>
  </nav>

  <main class="content">
    <!-- Barra de acciones: izquierda = toggle sidebar desktop | derecha = controles -->
    <div class="top-actions no-print">
      <div class="top-actions-left">
        <button class="sidebar-toggle-btn" id="sidebar-toggle-btn"
                onclick="toggleSidebar()" title="Mostrar/ocultar menÃº">âœ•</button>
      </div>
      <div class="top-actions-right">
        <select class="font-size-select" id="font-size-select"
                onchange="changeFontSize(this.value)" title="TamaÃ±o de letra">
          <option value="small">Aa pequeÃ±o</option>
          <option value="normal" selected>Aa normal</option>
          <option value="large">Aa grande</option>
        </select>
        <button class="theme-toggle" id="theme-toggle"
                onclick="toggleTheme()" title="Cambiar tema">ğŸŒ™</button>
        <button class="print-btn" onclick="window.print()"
                title="Usar 'Guardar como PDF' en el diÃ¡logo de impresiÃ³n">â¬‡ PDF</button>
        <div class="pii-loader">
          <button class="pii-load-btn" id="pii-load-btn"
                  title="Abogado: cargar pii-manifest.json para revelar datos reales">
            ğŸ”’ Revelar datos
          </button>
          <span class="pii-status" id="pii-status"></span>
        </div>
      </div>
    </div>

    <div class="disclaimer-bar no-print">
      <span class="disclaimer-short">âš  Este documento es orientativo y no constituye asesorÃ­a legal profesional.</span>
      <button class="disclaimer-expand-btn" id="disclaimer-expand-btn"
              onclick="toggleDisclaimerFull()" aria-expanded="false" title="Ver aviso completo">â“˜ mÃ¡s</button>
      <div class="disclaimer-full" id="disclaimer-full" hidden>
        Ha sido elaborado con apoyo de inteligencia artificial como guÃ­a orientativa.
        Su contenido es <strong>no vinculante</strong> y tiene carÃ¡cter exclusivamente informativo.
        Consulte con un abogado habilitado antes de actuar.
        Ver secciÃ³n <strong>Contactos para VerificaciÃ³n Profesional</strong> al final de cada documento.
      </div>
    </div>

    <h1 id="optimizacion-del-caso">OptimizaciÃ³n del Caso</h1>
<p class="page-subtitle">Airbnb Villarrica â€” Tax Optimization & Compliance Score &nbsp;Â·&nbsp; Actualizado 2026-02-15</p>

<div class="st-hero">
  <div class="score-ring score-ring-lg" aria-label="Score TOCS: 68 de 100, OPTIMIZADO">
    <svg viewBox="0 0 150 150">
      <circle class="bg" cx="75" cy="75" r="65" fill="none" stroke-width="8"/>
      <circle class="fill" cx="75" cy="75" r="65" fill="none" stroke-width="8" stroke-linecap="round"/>
    </svg>
    <div class="label">
      <span class="number" data-target="68">68</span>
      <span class="grade">OPTIMIZADO</span>
    </div>
  </div>
  <div class="st-context">
    <div class="st-context-title">DiseÃ±o completo â€” implementaciÃ³n pendiente</div>
    <p class="st-context-desc">La estructura tributaria estÃ¡ diseÃ±ada y validada. El techo actual es la implementaciÃ³n: resolver B1+C1-C4 y constituir la SpA llevarÃ­a el caso de 68 a 84/100 (BLINDADO). Ganancia acumulada: +68 puntos desde baseline.</p>
    <div class="meta-pills">
      <div class="pill"><span class="dot dot-blue"></span>SpA Pro-PyME</div>
      <div class="pill"><span class="dot dot-green"></span>TOCS 84 proyectado</div>
      <div class="pill"><span class="dot dot-amber"></span>4 acciones crÃ­ticas</div>
      <div class="pill"><span class="dot dot-red"></span>ImplementaciÃ³n: 3/10</div>
    </div>
  </div>
</div>

<h2 id="desglose-por-dimension-tocs">Desglose por DimensiÃ³n TOCS</h2>
<div class="st-dim-grid">

  <div class="st-dim-row">
    <div class="st-dim-header">
      <div class="st-dim-name">Estructura <span class="dim-weight">(20%)</span></div>
      <div class="st-dim-bar-track"><div class="st-dim-bar-fill green" data-width="80"></div></div>
      <div class="st-dim-score">8/10</div>
      <button class="st-dim-toggle" onclick="toggleDimDetail(this)" aria-expanded="false" title="Ver detalle">â–¾</button>
    </div>
    <div class="st-dim-detail-body" hidden>
      <p>âœ… <strong>Estructura sÃ³lida â€” pendiente confirmaciÃ³n Pro-PyME.</strong></p>
      <ul>
        <li>SpA operadora (Pro-PyME, Art. 14 D NÂ°3) + PN propietaria</li>
        <li>SeparaciÃ³n patrimonial correcta: SpA como arrendadora, Claudia como arrendataria a SpA</li>
        <li>Giro SII identificado: Art. 20 NÂ°3 (arriendos amoblados como actividades comerciales)</li>
      </ul>
      <p>âš  Pendiente: confirmaciÃ³n C1 (Art. 20 NÂ°3 viable con contador) â†’ +1 punto.</p>
      <p><a href="04_estructura/PROPUESTA-ESTRUCTURA.html">Ver Propuesta de Estructura â†’</a> | <a href="04_estructura/COMPARATIVA-ALTERNATIVAS.html">Comparativa alternativas â†’</a></p>
    </div>
  </div>

  <div class="st-dim-row">
    <div class="st-dim-header">
      <div class="st-dim-name">Compliance <span class="dim-weight">(20%)</span></div>
      <div class="st-dim-bar-track"><div class="st-dim-bar-fill red" data-width="50"></div></div>
      <div class="st-dim-score">5/10</div>
      <button class="st-dim-toggle" onclick="toggleDimDetail(this)" aria-expanded="false" title="Ver detalle">â–¾</button>
    </div>
    <div class="st-dim-detail-body" hidden>
      <p>ğŸ”´ <strong>DimensiÃ³n crÃ­tica â€” no hay compliance activo porque no se ha implementado.</strong></p>
      <p><strong>Pendiente (bloqueado por implementaciÃ³n):</strong></p>
      <ul>
        <li>ğŸ”´ Inicio de actividades en SII (persona natural arrendadora)</li>
        <li>ğŸ”´ ConstituciÃ³n SpA + inicio actividades SpA</li>
        <li>ğŸ”´ Primer F29 mensual</li>
        <li>ğŸŸ¡ Contrato de arriendo SpA â†’ Claudia</li>
        <li>ğŸŸ¡ FacturaciÃ³n por reservas Airbnb</li>
      </ul>
      <p>Post-implementaciÃ³n proyectado: 5 â†’ 8 (+3). Ver <a href="99_entregable/07_operacion/mensual/guia-mensual.html">GuÃ­a Mensual OperaciÃ³n â†’</a></p>
    </div>
  </div>

  <div class="st-dim-row">
    <div class="st-dim-header">
      <div class="st-dim-name">OptimizaciÃ³n <span class="dim-weight">(15%)</span></div>
      <div class="st-dim-bar-track"><div class="st-dim-bar-fill green" data-width="80"></div></div>
      <div class="st-dim-score">8/10</div>
      <button class="st-dim-toggle" onclick="toggleDimDetail(this)" aria-expanded="false" title="Ver detalle">â–¾</button>
    </div>
    <div class="st-dim-detail-body" hidden>
      <p>âœ… <strong>OptimizaciÃ³n mÃ¡xima identificada para el caso.</strong></p>
      <ul>
        <li>Gastos deducibles SpA: amoblamiento, consumibles, servicios, comisiÃ³n Airbnb, seguro RC</li>
        <li>RÃ©gimen Pro-PyME: tasa 1ra categorÃ­a 10% vs 27% rÃ©gimen general</li>
        <li>Ahorro proyectado: ~$2,4Mâ€“$3,1M CLP anuales vs persona natural</li>
        <li>Intereses hipotecarios potencialmente deducibles (C3 pendiente)</li>
      </ul>
      <p>âš  Pendiente: confirmaciÃ³n C3 (intereses hipotecarios) â†’ +0,5 punto.</p>
      <p><a href="03_simulacion/SIMULACION-5-ANOS.html">Ver SimulaciÃ³n 5 AÃ±os â†’</a></p>
    </div>
  </div>

  <div class="st-dim-row">
    <div class="st-dim-header">
      <div class="st-dim-name">DocumentaciÃ³n <span class="dim-weight">(15%)</span></div>
      <div class="st-dim-bar-track"><div class="st-dim-bar-fill green" data-width="90"></div></div>
      <div class="st-dim-score">9/10</div>
      <button class="st-dim-toggle" onclick="toggleDimDetail(this)" aria-expanded="false" title="Ver detalle">â–¾</button>
    </div>
    <div class="st-dim-detail-body" hidden>
      <p>âœ… <strong>TECHO â€” 11 documentos completos. No iterar mÃ¡s.</strong></p>
      <ul>
        <li><a href="02_analisis/ANALISIS-TRIBUTARIO.html">AnÃ¡lisis Tributario</a> â€” completo con diagnÃ³stico</li>
        <li><a href="02_analisis/clasificacion-pro-pyme-art20.html">ClasificaciÃ³n Pro-PyME</a> â€” Art. 20 NÂ°3 fundamentado</li>
        <li><a href="02_analisis/mapeo-costos-operacionales.html">Mapeo Costos Operacionales</a> â€” 15+ conceptos deducibles</li>
        <li><a href="03_simulacion/SIMULACION-5-ANOS.html">SimulaciÃ³n 5 AÃ±os</a> â€” 3 escenarios comparados</li>
        <li><a href="04_estructura/PROPUESTA-ESTRUCTURA.html">Propuesta de Estructura</a> + <a href="04_estructura/COMPARATIVA-ALTERNATIVAS.html">Comparativa</a></li>
        <li><a href="05_revision/2026-02-15-roast.html">ROAST SII</a> + <a href="05_revision/2026-02-15-proof.html">PROOF Compliance</a></li>
        <li><a href="99_entregable/entrega-profesional/ENTREGA-PROFESIONAL.html">Entrega Profesional consolidada</a></li>
        <li>GuÃ­as de operaciÃ³n: <a href="99_entregable/07_operacion/mensual/guia-mensual.html">mensual</a>, <a href="99_entregable/07_operacion/anual/guia-anual.html">anual</a>, <a href="99_entregable/07_operacion/eventual/guia-por-reserva.html">por reserva</a></li>
      </ul>
    </div>
  </div>

  <div class="st-dim-row">
    <div class="st-dim-header">
      <div class="st-dim-name">Riesgo <span class="dim-weight">(10%)</span></div>
      <div class="st-dim-bar-track"><div class="st-dim-bar-fill amber" data-width="70"></div></div>
      <div class="st-dim-score">7/10</div>
      <button class="st-dim-toggle" onclick="toggleDimDetail(this)" aria-expanded="false" title="Ver detalle">â–¾</button>
    </div>
    <div class="st-dim-detail-body" hidden>
      <p>âš  <strong>Riesgo moderado â€” dos bloqueantes activos.</strong></p>
      <ul>
        <li>ğŸ”´ B1: Reglamento copropiedad â€” puede prohibir arriendos corta estadÃ­a</li>
        <li>ğŸŸ¡ C1: Art. 20 NÂ°3 pendiente confirmar con contador</li>
        <li>âœ… Estructura SpA tiene sustancia econÃ³mica real</li>
        <li>âœ… IVA comisiÃ³n Airbnb analizado (P2)</li>
      </ul>
      <p>Post-implementaciÃ³n proyectado: 7 â†’ 9 (+2). Ver <a href="05_revision/2026-02-15-roast.html">ROAST SII â†’</a> | <a href="99_entregable/02_bloqueantes/B1-reglamento-copropiedad.html">B1 Reglamento â†’</a></p>
    </div>
  </div>

  <div class="st-dim-row">
    <div class="st-dim-header">
      <div class="st-dim-name">Normativa <span class="dim-weight">(10%)</span></div>
      <div class="st-dim-bar-track"><div class="st-dim-bar-fill green" data-width="80"></div></div>
      <div class="st-dim-score">8/10</div>
      <button class="st-dim-toggle" onclick="toggleDimDetail(this)" aria-expanded="false" title="Ver detalle">â–¾</button>
    </div>
    <div class="st-dim-detail-body" hidden>
      <p>âœ… <strong>Marco normativo sÃ³lido â€” DL 824 + DL 825 + jurisprudencia.</strong></p>
      <ul>
        <li>Art. 20 NÂ°3 DL 824: clasificaciÃ³n arriendos amoblados como comerciales</li>
        <li>Art. 14 D NÂ°3 DL 824: rÃ©gimen Pro-PyME para SpA</li>
        <li>Art. 31 DL 824: gastos necesarios para producir la renta</li>
        <li>Jurisprudencia TTA en arriendos amoblados identificada</li>
        <li>Circulares SII relevantes revisadas</li>
      </ul>
      <p>âš  Pendiente: verificar interpretaciÃ³n IVA comisiÃ³n Airbnb (P2). Ver <a href="01_investigacion/INVESTIGACION-COMPILADA.html">InvestigaciÃ³n Compilada â†’</a></p>
    </div>
  </div>

  <div class="st-dim-row">
    <div class="st-dim-header">
      <div class="st-dim-name">ImplementaciÃ³n <span class="dim-weight">(10%)</span></div>
      <div class="st-dim-bar-track"><div class="st-dim-bar-fill red" data-width="30"></div></div>
      <div class="st-dim-score">3/10</div>
      <button class="st-dim-toggle" onclick="toggleDimDetail(this)" aria-expanded="false" title="Ver detalle">â–¾</button>
    </div>
    <div class="st-dim-detail-body" hidden>
      <p>ğŸ”´ <strong>DimensiÃ³n con mayor potencial de mejora (+5 puntos).</strong> Solo el plan existe.</p>
      <p><strong>Fases pendientes (en orden):</strong></p>
      <ul>
        <li>ğŸ”´ Fase 0: Resolver B1 (reglamento copropiedad) + C1-C4 con contador</li>
        <li>ğŸ”´ Fase 1: Inicio actividades SII Claudia como arrendadora PN</li>
        <li>ğŸ”´ Fase 2: Constituir SpA ante notario + inscribir SII</li>
        <li>ğŸŸ¡ Fase 3: Formalizar contrato arriendo Claudia â†’ SpA</li>
        <li>ğŸŸ¡ Fase 4: Amoblar, registrar SERNATUR, contratar seguro RC</li>
      </ul>
      <p>Post-implementaciÃ³n proyectado: 3 â†’ 8 (+5). Ver <a href="99_entregable/06_con-supervision-ia/R1-reunion-contador-consolidada.html">ReuniÃ³n contador consolidada â†’</a></p>
    </div>
  </div>

</div>

<h2 id="historial-de-iteraciones">Historial de Iteraciones</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>#</th>
<th>Fecha</th>
<th>Comando</th>
<th style="text-align: center;">Antes</th>
<th style="text-align: center;">DespuÃ©s</th>
<th style="text-align: center;">Delta</th>
<th>Notas</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2026-02-15</td>
<td>SCORE (baseline)</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">68</td>
<td style="text-align: center;">+68</td>
<td>Primera mediciÃ³n. DiseÃ±o completo, ejecuciÃ³n pendiente</td>
</tr>
</tbody>
</table></div>
<p><strong>Ganancia acumulada: +68 puntos desde baseline | Estado: BASELINE ESTABLECIDO</strong></p>
<h2 id="proyeccion-post-implementacion">ProyecciÃ³n Post-ImplementaciÃ³n</h2>
<p>Si se resuelve B1+C1-C4 favorablemente y se implementa la estructura:</p>
<pre><code>ImplementaciÃ³n: 3 â†’ 8 (+5)
Compliance:     5 â†’ 8 (+3)
Riesgo:         7 â†’ 9 (+2)
Estructura:     8 â†’ 9 (+1)

Score proyectado: 84/100 (BLINDADO) â† cruce de umbral
</code></pre>
<h2 id="hitos">Hitos</h2>
<ul>
<li class="task-item"><input type="checkbox" checked disabled>  SIN ESTRUCTURA (0â€“25): superado al inicio</li>
<li class="task-item"><input type="checkbox" checked disabled>  EN ANÃLISIS (26â€“45): superado en primeras sesiones</li>
<li class="task-item"><input type="checkbox" checked disabled>  ESTRUCTURADO (46â€“65): superado con simulaciÃ³n y estructura</li>
<li class="task-item"><input type="checkbox" checked disabled>  <strong>OPTIMIZADO (66â€“80): TOCS 68/100 â€” ACTUAL</strong> â† baseline establecido</li>
<li class="task-item"><input type="checkbox" disabled>  BLINDADO (81â€“90): requiere implementaciÃ³n B1+C1-C4 â†’ proyectado 84/100</li>
<li class="task-item"><input type="checkbox" disabled>  EXCELENCIA (91+): requiere operaciÃ³n activa + compliance histÃ³rico</li>
</ul>

    <footer class="site-footer no-print">
      <hr>
      <small>Contenido generado con apoyo de IA â€” orientativo, no vinculante. Consulte con un abogado habilitado.</small>
    </footer>
  </main>

  <script>
    // â”€â”€ Indicador de pÃ¡gina activa en sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function() {
      var current = window.location.href.split('?')[0].split('#')[0];
      document.querySelectorAll('.sidebar a').forEach(function(link) {
        if (link.href.split('?')[0].split('#')[0] === current)
          link.classList.add('active');
      });
    })();

    // â”€â”€ Cargador PII client-side â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function() {
      var btn = document.getElementById('pii-load-btn');
      var status = document.getElementById('pii-status');
      if (!btn) return;
      btn.addEventListener('click', function() {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        input.onchange = function(e) {
          var file = e.target.files[0];
          if (!file) return;
          var reader = new FileReader();
          reader.onload = function(ev) {
            try {
              var manifest = JSON.parse(ev.target.result);
              var spans = document.querySelectorAll('.pii-redacted');
              var count = 0;
              spans.forEach(function(span) {
                var token = span.getAttribute('data-token');
                if (manifest[token]) {
                  span.textContent = manifest[token];
                  span.classList.remove('pii-redacted');
                  span.classList.add('pii-revealed');
                  count++;
                }
              });
              if (count > 0) {
                btn.textContent = 'âœ“ Datos revelados (' + count + ')';
                btn.classList.add('pii-loaded');
                if (status) status.textContent = '';
              } else {
                if (status) status.textContent = 'Sin datos en esta pÃ¡gina';
              }
            } catch(err) {
              if (status) status.textContent = 'Error: JSON invÃ¡lido';
            }
          };
          reader.readAsText(file);
        };
        input.click();
      });
    })();

    // â”€â”€ Mermaid: guardar fuentes ANTES de render, luego inicializar â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', function() {
      // 1. Guardar innerHTML original antes de que Mermaid lo reemplace
      document.querySelectorAll('.mermaid').forEach(function(el, i) {
        var id = 'mermaid-' + i;
        el.setAttribute('data-mermaid-id', id);
        window._mermaidSrc[id] = el.innerHTML.trim();
      });
      // 2. Renderizar
      mermaid.run({ querySelector: '.mermaid' });
    });

    // â”€â”€ Theme toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyTheme(t) {
      document.documentElement.setAttribute('data-theme', t);
      var btn = document.getElementById('theme-toggle');
      if (btn) btn.textContent = t === 'dark' ? 'â˜€' : 'ğŸŒ™';

      var mermaidTheme = t === 'dark' ? 'dark' : 'neutral';
      mermaid.initialize({ startOnLoad: false, theme: mermaidTheme });

      // Re-renderizar diagramas desde fuente original guardada
      document.querySelectorAll('.mermaid').forEach(function(el) {
        var id = el.getAttribute('data-mermaid-id');
        var src = id ? window._mermaidSrc[id] : null;
        if (src) {
          el.removeAttribute('data-processed');
          el.innerHTML = src;
        }
      });
      mermaid.run({ querySelector: '.mermaid' });
    }

    function toggleTheme() {
      var next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      applyTheme(next);
      try { localStorage.setItem('villarrica-theme', next); } catch(e) {}
    }

    // Restaurar Ã­cono del tema al cargar
    (function() {
      try {
        var saved = localStorage.getItem('villarrica-theme') || 'light';
        var btn = document.getElementById('theme-toggle');
        if (btn) btn.textContent = saved === 'dark' ? 'â˜€' : 'ğŸŒ™';
      } catch(e) {}
    })();

    // â”€â”€ Sidebar toggle (desktop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleSidebar() {
      var collapsed = document.body.classList.toggle('sidebar-collapsed');
      var btn = document.getElementById('sidebar-toggle-btn');
      if (btn) btn.textContent = collapsed ? 'â˜°' : 'âœ•';
      try { localStorage.setItem('villarrica-sidebar', collapsed ? '1' : '0'); } catch(e) {}
    }

    // Restaurar estado sidebar al cargar
    (function() {
      try {
        if (localStorage.getItem('villarrica-sidebar') === '1') {
          document.body.classList.add('sidebar-collapsed');
          var btn = document.getElementById('sidebar-toggle-btn');
          if (btn) btn.textContent = 'â˜°';
        }
      } catch(e) {}
    })();

    // â”€â”€ Font size selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var _fontSizes = { small: '0.875rem', normal: '1rem', large: '1.125rem' };

    function changeFontSize(size) {
      var val = _fontSizes[size] || '1rem';
      document.documentElement.style.setProperty('--font-size-base', val);
      try { localStorage.setItem('villarrica-fontsize', size); } catch(e) {}
    }

    // Restaurar tamaÃ±o de letra al cargar
    document.addEventListener('DOMContentLoaded', function() {
      try {
        var saved = localStorage.getItem('villarrica-fontsize');
        if (saved && _fontSizes[saved]) {
          document.documentElement.style.setProperty('--font-size-base', _fontSizes[saved]);
          var sel = document.getElementById('font-size-select');
          if (sel) sel.value = saved;
        }
      } catch(e) {}
    });

    // â”€â”€ Disclaimer expandible â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleDisclaimerFull() {
      var el = document.getElementById('disclaimer-full');
      var btn = document.getElementById('disclaimer-expand-btn');
      if (!el || !btn) return;
      var expanded = !el.hidden;
      el.hidden = expanded;
      btn.setAttribute('aria-expanded', String(!expanded));
      btn.textContent = expanded ? 'â“˜ mÃ¡s' : 'âœ• cerrar';
    }

    // â”€â”€ Sidebar accordion (secciones colapsables) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', function() {
      var titles = document.querySelectorAll('.sidebar li.section-title');
      titles.forEach(function(title) {
        var ul = title.nextElementSibling;
        if (!ul || ul.tagName !== 'UL') return;

        // Indicador de toggle
        var icon = document.createElement('span');
        icon.className = 'section-toggle-icon';
        icon.textContent = 'â–¸';
        title.appendChild(icon);
        title.setAttribute('tabindex', '0');

        // Empezar colapsado
        ul.style.display = 'none';
        ul.style.marginTop = '0';

        function toggle() {
          var open = ul.style.display !== 'none';
          ul.style.display = open ? 'none' : '';
          icon.textContent = open ? 'â–¸' : 'â–¾';
        }
        title.addEventListener('click', toggle);
        title.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
        });
      });

      // Expandir la secciÃ³n que contiene el enlace activo
      var activeLink = document.querySelector('.sidebar a.active');
      if (activeLink) {
        var el = activeLink.parentElement;
        var sidebar = document.querySelector('.sidebar');
        while (el && el !== sidebar) {
          if (el.tagName === 'UL') {
            el.style.display = '';
            var prev = el.previousElementSibling;
            if (prev && prev.classList.contains('section-title')) {
              var icon = prev.querySelector('.section-toggle-icon');
              if (icon) icon.textContent = 'â–¾';
            }
          }
          el = el.parentElement;
        }
      }
    });

    // â”€â”€ Scroll reveal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', function() {
      if (!window.IntersectionObserver) return;
      var targets = document.querySelectorAll('h2, .table-wrapper, blockquote');
      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(e) {
          if (e.isIntersecting) {
            e.target.classList.add('visible');
            observer.unobserve(e.target);
          }
        });
      }, { threshold: 0.08 });
      targets.forEach(function(el) {
        el.classList.add('reveal');
        observer.observe(el);
      });
    });

    // â”€â”€ Score ring: count-up + fill stroke (dynamic radius) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.score-ring').forEach(function(ring) {
        var numEl = ring.querySelector('.number[data-target]');
        if (!numEl) return;
        var target = parseInt(numEl.getAttribute('data-target'), 10);
        var fillCircle = ring.querySelector('circle.fill');

        if (fillCircle) {
          var r = parseFloat(fillCircle.getAttribute('r') || '44');
          var circumference = 2 * Math.PI * r;
          fillCircle.style.strokeDasharray = String(circumference);
          fillCircle.style.strokeDashoffset = String(circumference); // start empty
          setTimeout(function() {
            fillCircle.style.strokeDashoffset = String(circumference * (1 - target / 100));
          }, 150);
        }

        // Count-up number
        var duration = 1200;
        var startTime = null;
        function step(ts) {
          if (!startTime) startTime = ts;
          var progress = Math.min((ts - startTime) / duration, 1);
          var eased = 1 - Math.pow(1 - progress, 3);
          numEl.textContent = Math.round(target * eased);
          if (progress < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      });
    });

    // â”€â”€ Strength tracker: dimension toggle + bar animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleDimDetail(btn) {
      var row = btn.closest('.st-dim-row');
      if (!row) return;
      var body = row.querySelector('.st-dim-detail-body');
      if (!body) return;
      var open = !body.hidden;
      body.hidden = open;
      btn.setAttribute('aria-expanded', String(!open));
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Animate dimension bars on load
      setTimeout(function() {
        document.querySelectorAll('.st-dim-bar-fill[data-width]').forEach(function(bar) {
          bar.style.width = bar.getAttribute('data-width') + '%';
        });
      }, 300);
    });

    // â”€â”€ Severity row auto-detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Detecta keywords en celdas cortas (<35 chars) y agrega clase al <tr>
    document.addEventListener('DOMContentLoaded', function() {
      var reCritical = /urgente|cr[iÃ­]tic[ao]|bloqueado|bloqueante|ğŸ”´/i;
      var reSuccess  = /completo|completado|resuelto|listo|blindado|âœ“|âœ…|ğŸŸ¢/i;
      var reWarning  = /pendiente|revisar|verificar|atenci[oÃ³]n|ğŸŸ¡|âš /i;
      document.querySelectorAll('table tr').forEach(function(row) {
        if (row.closest('thead')) return;
        var cells = row.querySelectorAll('td');
        var detected = null;
        cells.forEach(function(td) {
          var t = td.textContent.trim();
          if (t.length > 35) return;
          if (!detected && reCritical.test(t)) detected = 'critical';
          else if (!detected && reSuccess.test(t))  detected = 'success';
          else if (!detected && reWarning.test(t))  detected = 'warning';
        });
        if (detected) row.classList.add('row-' + detected);
      });
    });
  </script>
</body>
</html>
